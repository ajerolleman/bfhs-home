<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Callback</title>
    <script>
      (function () {
        var params = new URLSearchParams(window.location.search);
        var code = params.get('code');
        var error = params.get('error');
        var verifier = sessionStorage.getItem('spotify_code_verifier');
        if (error || !code || !verifier) {
          window.location.replace(window.location.origin + '/');
          return;
        }

        var body = new URLSearchParams({
          client_id: '74092c1583494edcae059620291957ed',
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: 'https://bfhs-home.onrender.com/callback',
          code_verifier: verifier
        });

        fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (data && data.access_token) {
              localStorage.setItem('spotify_token', data.access_token);
              if (data.expires_in) {
                var expiresAt = Date.now() + Number(data.expires_in) * 1000;
                localStorage.setItem('spotify_token_expires_at', String(expiresAt));
              }
            }
          })
          .finally(function () {
            window.location.replace(window.location.origin + '/');
          });
      })();
    </script>
  </head>
  <body>
    Redirecting...
  </body>
</html>
